name: "rescript-generated-js-diff"
description: "Generated a diff of the generated JS files for a PR of a ReScript project"
author: "https://github.com/zth"
branding:
  icon: "archive"
  color: "purple"

inputs:
  project_dir:
    description: "Directory of the ReScript project to scan (where `rescript.json` or `bsconfig.json` is located)"
    required: true
  target_branch:
    description: "Branch to compare against"
    required: false
    default: "main"
  html_artifact_name:
    description: "Name for the HTML diff artifact (no placeholders). If omitted, a default based on branches will be used."
    required: false
    default: ""
  diff_style:
    description: "Diff style for diff2html: side or line"
    required: false
    default: "side"

outputs:
  zip_path:
    description: "Absolute path to the created zip file for the current branch"
    value: ${{ steps.setup.outputs.zip_path }}
  diff_html_path:
    description: "Absolute path to the produced diff HTML (if previous artifact was found)"
    value: ${{ steps.generate_diff.outputs.diff_html_path }}
  diff_patch_path:
    description: "Absolute path to the produced unified diff patch (if previous artifact was found)"
    value: ${{ steps.generate_diff.outputs.diff_patch_path }}

runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Install action dependencies
      shell: bash
      working-directory: ${{ github.action_path }}
      run: npm ci --omit=dev

    - id: setup
      name: Prepare paths and names
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        CURRENT_BRANCH: ${{ github.ref_name }}
        INPUT_TARGET_BRANCH: ${{ inputs.target_branch }}
        GITHUB_BASE_REF: ${{ github.base_ref }}
        GITHUB_HEAD_REF: ${{ github.head_ref }}
      run: bash "${{ github.action_path }}/scripts/setup.sh"

    - name: Build zip
      shell: bash
      working-directory: ${{ github.workspace }}
      run: node "${{ github.action_path }}/src/RescriptGeneratedJsDiff.res.mjs" save-generated-js "${{ inputs.project_dir }}" "${{ steps.setup.outputs.zip_path }}"

    - name: Upload current zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.setup.outputs.zip_name }}
        path: ${{ steps.setup.outputs.zip_path }}
        if-no-files-found: error

    - name: Download previous artifact for target branch
      id: download_prev
      if: ${{ steps.setup.outputs.is_same_branch != 'true' }}
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{ github.token }}
        branch: ${{ steps.setup.outputs.target_branch }}
        name: latest-diff--${{ steps.setup.outputs.target_safe }}.zip
        path: .rgjd-cache/prev
        workflow_conclusion: success
      continue-on-error: true

    - id: prev_info
      name: Locate previous zip
      if: ${{ steps.setup.outputs.is_same_branch != 'true' }}
      shell: bash
      working-directory: ${{ github.workspace }}
      run: bash "${{ github.action_path }}/scripts/prev_info.sh"

    - id: generate_diff
      name: Generate diff HTML
      if: ${{ steps.setup.outputs.is_same_branch != 'true' && steps.prev_info.outputs.found == 'true' }}
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        INPUT_DIFF_STYLE: ${{ inputs.diff_style }}
        IN_NAME: ${{ inputs.html_artifact_name }}
        CURR_SAFE: ${{ steps.setup.outputs.branch_safe }}
        TGT_SAFE: ${{ steps.setup.outputs.target_safe }}
      run: bash "${{ github.action_path }}/scripts/generate_diff.sh" "${{ steps.setup.outputs.zip_path }}" "${{ steps.prev_info.outputs.zip_path }}"

    - id: upload_html
      name: Upload diff HTML artifact
      if: ${{ steps.setup.outputs.is_same_branch != 'true' && steps.prev_info.outputs.found == 'true' && steps.generate_diff.outputs.has_changes == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.generate_diff.outputs.html_name }}
        path: ${{ steps.generate_diff.outputs.diff_html_path }}
        if-no-files-found: error

    - id: upload_patch
      name: Upload diff patch artifact
      if: ${{ steps.setup.outputs.is_same_branch != 'true' && steps.prev_info.outputs.found == 'true' && steps.generate_diff.outputs.has_changes == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.generate_diff.outputs.patch_name }}
        path: ${{ steps.generate_diff.outputs.diff_patch_path }}
        if-no-files-found: error

    - name: Add job summary
      shell: bash
      env:
        BRANCH: ${{ steps.setup.outputs.branch_name }}
        TARGET: ${{ steps.setup.outputs.target_branch }}
        RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        HTML_ART_ID: ${{ steps.upload_html.outputs.artifact-id }}
        PATCH_ART_ID: ${{ steps.upload_patch.outputs.artifact-id }}
        IS_SAME_BRANCH: ${{ steps.setup.outputs.is_same_branch }}
        PREV_FOUND: ${{ steps.prev_info.outputs.found }}
        HAS_CHANGES: ${{ steps.generate_diff.outputs.has_changes }}
        PATCH_PATH: ${{ steps.generate_diff.outputs.diff_patch_path }}
      run: bash "${{ github.action_path }}/scripts/add_summary.sh"
